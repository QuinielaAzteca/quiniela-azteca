<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monitor Quiniela (Clasificación)</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2e;
      --line:rgba(255,255,255,.10);
      --text:#e5e7eb;
      --muted:#94a3b8;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background: radial-gradient(1000px 520px at 50% -140px, #111827 0%, var(--bg) 55%, #070b14 100%);
      color:var(--text);
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:14px;
    }
    .top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .title h1{
      margin:0;
      font-size:18px;
      letter-spacing:.02em;
    }
    .title .sub{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }
    .right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      white-space:nowrap;
    }
    .chip b{color:var(--text)}
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 10px;
      border-radius:10px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      transition:transform .06s ease, background .12s ease;
    }
    .btn:active{transform:scale(.98)}
    .btn:hover{background: rgba(255,255,255,.10)}
    .main{
      margin-top:12px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
    }
    .tableWrap{
      width:100%;
      overflow:auto; /* aquí sí queremos scroll si se ocupa en escritorio */
      max-height:74vh;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:720px;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:5;
      text-align:left;
      font-size:12px;
      letter-spacing:.02em;
      color:#cbd5e1;
      background: rgba(15,26,46,.95);
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      white-space:nowrap;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:12px;
      color:var(--text);
      white-space:nowrap;
    }
    tbody tr:hover td{
      background: rgba(255,255,255,.03);
    }
    td.num{
      font-variant-numeric:tabular-nums;
      text-align:right;
    }
    td.center{text-align:center}
    .muted{color:var(--muted)}
    .err{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(248,113,113,.35);
      background: rgba(248,113,113,.08);
      color:#fecaca;
      font-weight:800;
      display:none;
    }
    .hint{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      line-height:1.35;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>Monitor – Clasificación Quiniela</h1>
        <div class="sub">Fuente: <span class="muted">clasificacion_prueba</span> · Actualiza solo (polling)</div>
      </div>

      <div class="right">
        <div class="chip">Estado: <b id="estadoTxt">—</b></div>
        <div class="chip">Última actualización: <b id="lastTxt">—</b></div>
        <button class="btn" id="btnNow">Actualizar ahora</button>
      </div>
    </div>

    <div class="main">
      <div class="tableWrap">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="err" id="errBox"></div>

    <div class="hint">
      Tip: este monitor solo <b>lee</b> tu WebApp con <code>?mode=clasif</code>. <br/>
      Si no ves datos, primero corre <b>generarClasificacionPrueba()</b> en Apps Script para llenar la hoja.
    </div>
  </div>

<script>
  const ENDPOINT = "https://script.google.com/macros/s/AKfycbyGqoqBpUMbf34qt3cMBbvlsCuf-PXqK8Dvhv7Vzj4dgzNT9pBJ0-_UHkc-IvnPqZ1Y/exec?mode=clasif";

  const $ = s => document.querySelector(s);

  function fmtTime(d){
    try{
      return d.toLocaleString('es-MX', { hour12:false });
    }catch(e){
      return d.toISOString();
    }
  }

  function showError(msg){
    const box = $('#errBox');
    box.style.display = 'block';
    box.textContent = String(msg || 'Error');
    $('#estadoTxt').textContent = 'ERROR';
  }

  function clearError(){
    const box = $('#errBox');
    box.style.display = 'none';
    box.textContent = '';
  }

  function isNum(val){
    if (val === null || val === undefined) return false;
    const s = String(val).trim();
    if (!s) return false;
    return /^-?\d+(\.\d+)?$/.test(s);
  }

  function renderTable(headers, rows){
    const thead = $('#thead');
    const tbody = $('#tbody');

    thead.innerHTML = '<tr>' + headers.map(h => `<th>${escapeHtml(h)}</th>`).join('') + '</tr>';

    tbody.innerHTML = rows.map(r => {
      return '<tr>' + r.map((c, idx) => {
        const v = (c === null || c === undefined) ? '' : c;
        const cls = (idx === headers.length - 1 || isNum(v)) ? 'num' : '';
        // Aciertos al centro si quieres: (headers[idx] === 'aciertos') ? 'center' : ''
        return `<td class="${cls}">${escapeHtml(String(v))}</td>`;
      }).join('') + '</tr>';
    }).join('');
  }

  function escapeHtml(s){
    return s
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  async function load(){
    try{
      $('#estadoTxt').textContent = 'Cargando...';
      clearError();

      const r = await fetch(ENDPOINT, { cache:'no-store' });
      const j = await r.json();

      if (!j.ok) throw new Error(j.error || 'Respuesta no ok');

      const data = j.data || {};
      const headers = data.headers || [];
      const rows = data.rows || [];

      renderTable(headers, rows);

      $('#estadoTxt').textContent = 'OK';
      $('#lastTxt').textContent = fmtTime(new Date());
    } catch (e){
      showError(e && e.message ? e.message : e);
      $('#lastTxt').textContent = fmtTime(new Date());
    }
  }

  $('#btnNow').addEventListener('click', load);

  load();
  setInterval(load, 5000); // refresca cada 5 segundos
</script>
</body>
</html>
