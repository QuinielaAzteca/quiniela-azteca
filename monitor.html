<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Quiniela Azteca ‚Äì Clasificaci√≥n</title>

<style>
  :root{
    --bg:#eef6f1;
    --card:#ffffff;
    --line:#cfe5da;
    --muted:#6b7280;

    --hit:#22c55e;         /* verde sem√°foro */
    --hitText:#ffffff;

    --win1:#f3f4f6;        /* grises */
    --win2:#e5e7eb;

    --wFolio:56px;
    --wNombre:220px;
    --wSel:34px;
    --wA:40px;

    --sbw:0px; /* scrollbar width compensation */
  }

  *{ box-sizing:border-box; }
  html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg);
    color:#0f172a;
    overflow-x:hidden;
  }
  a{ color:inherit; text-decoration:none; }

  .top{
    position:sticky; top:0; z-index:50;
    background:rgba(238,246,241,.92);
    backdrop-filter: blur(8px);
    border-bottom:1px solid var(--line);
  }

  .headCard{
    margin:10px 10px 8px;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:16px;
    overflow:hidden;
  }

  .titleRow{
    padding:10px 12px 0;
  }
  .title{
    font-weight:900;
    letter-spacing:.5px;
    font-size:18px;
    line-height:1.1;
  }
  .subtitle{
    margin-top:2px;
    font-weight:800;
    color:var(--muted);
    font-size:13px;
  }

  .partidos{
    padding:8px 10px 10px;
  }
  .p{
    display:flex;
    justify-content:space-between;
    gap:10px;
    padding:5px 6px;
    border-top:1px solid #edf6ef;
    font-size:12px;
  }
  .p:first-child{ border-top:none; }
  .p .left{
    font-weight:800;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .p .right{ display:flex; gap:6px; align-items:center; }
  .chip{
    min-width:52px;
    text-align:center;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid #d7e5dc;
    background:#f6fbf8;
    font-weight:900;
  }
  .chip.pick{
    min-width:40px;
    background:#e9fbf1;
    border-color:#bfead0;
    color:#065f46;
  }

  .searchCard{
    margin:0 10px 10px;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:16px;
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .searchBox{
    position:relative;
  }
  .searchBox input{
    width:100%;
    padding:14px 14px 14px 50px;
    font-size:16px;
    font-weight:800;
    border-radius:16px;
    border:2px solid #c9d7cf;
    outline:none;
    background:#fff;
  }
  .searchBox .icon{
    position:absolute;
    left:14px; top:50%;
    transform:translateY(-50%);
    font-size:22px;
    opacity:.7;
  }

  .pagerRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  .pagerText{
    font-weight:900;
    color:#334155;
    font-size:16px;
  }
  .pagerBtns{
    display:flex;
    gap:10px;
  }
  .btn{
    width:54px; height:44px;
    border-radius:14px;
    border:2px solid #c9d7cf;
    background:#fff;
    font-weight:900;
    font-size:20px;
    cursor:pointer;
  }
  .btn:disabled{
    opacity:.35;
    cursor:default;
  }

  .tableWrap{
    margin:0 10px 16px;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:16px;
    overflow:hidden;
  }

  /* Header de columnas fijo */
  .gridHead{
    position:sticky;
    top: calc(0px + 0px); /* se queda pegado dentro del scroll principal */
    z-index:40;
    background:rgba(255,255,255,.96);
    border-bottom:1px solid #e6f2ea;
    padding-right:var(--sbw);
  }
  .gridRow{
    display:grid;
    grid-template-columns: var(--wFolio) var(--wNombre) repeat(9, var(--wSel)) var(--wA);
    align-items:center;
    column-gap:6px;
    padding:10px 10px;
  }
  .hcell{
    font-weight:900;
    color:#0f172a;
    font-size:14px;
  }
  .hnum{
    text-align:center;
  }

  /* Lista */
  #listBox{
    max-height: calc(100vh - 390px);
    overflow:auto;
    -webkit-overflow-scrolling:touch;
  }

  .row{
    border-bottom:1px solid #edf6ef;
  }
  .row.win1{ background:var(--win1); }
  .row.win2{ background:var(--win2); }

  .folio{
    font-weight:900;
    color:#334155;
    font-size:16px;
  }
  .name{
    font-weight:1000;
    font-size:18px;
    letter-spacing:.2px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }

  .pill{
    display:inline-flex;
    width:32px;
    height:32px;
    border-radius:999px;
    align-items:center;
    justify-content:center;
    font-weight:1000;
    border:2px solid #cbd5e1;
    background:#fff;
    color:#0f172a;
    margin:0 auto;
  }
  .pill.hit{
    background:var(--hit);
    border-color:#16a34a;
    color:var(--hitText);
  }

  .ac{
    text-align:center;
    font-weight:1000;
    font-size:18px;
    color:#0f172a;
  }
  .row.win1 .ac, .row.win2 .ac{
    color:#111827;
  }

  /* mensajes */
  .msg{
    padding:12px 10px;
    text-align:center;
    color:#64748b;
    font-weight:800;
  }

  /* quitar ‚Äúsubrayados raros‚Äù del navegador */
  .p, .gridRow, .row, .name, .folio { text-decoration:none !important; }
</style>
</head>

<body>

<div class="top">
  <div class="headCard">
    <div class="titleRow">
      <div class="title">QUINIELA AZTECA</div>
      <div class="subtitle" id="weekTxt"></div>
    </div>

    <div class="partidos" id="partidosTxt"></div>
  </div>

  <div class="searchCard">
    <div class="searchBox">
      <div class="icon">üîé</div>
      <input id="searchInput" placeholder="Busca aqu√≠ por tel√©fono, nombre o folio" autocomplete="off" inputmode="search">
    </div>

    <div class="pagerRow">
      <div class="pagerText">
        <span id="pageTxt">P√°gina 1 / 1</span>
        <span style="opacity:.6">¬∑</span>
        <span id="totalTxt">0 registros</span>
      </div>
      <div class="pagerBtns">
        <button class="btn" id="btnPrev" aria-label="Anterior">‚Äπ</button>
        <button class="btn" id="btnNext" aria-label="Siguiente">‚Ä∫</button>
      </div>
    </div>

    <div id="loadingMsg" class="msg" hidden>Cargando‚Ä¶</div>
    <div id="noMatchMsg" class="msg" hidden>Sin coincidencias.</div>
  </div>

  <div class="tableWrap">
    <div class="gridHead">
      <div class="gridRow">
        <div class="hcell">#</div>
        <div class="hcell">Nombre</div>
        <div class="hcell hnum">1</div>
        <div class="hcell hnum">2</div>
        <div class="hcell hnum">3</div>
        <div class="hcell hnum">4</div>
        <div class="hcell hnum">5</div>
        <div class="hcell hnum">6</div>
        <div class="hcell hnum">7</div>
        <div class="hcell hnum">8</div>
        <div class="hcell hnum">9</div>
        <div class="hcell hnum">Ac</div>
      </div>
    </div>

    <div id="listBox">
      <div id="list"></div>
    </div>
  </div>
</div>

<script>
const BASE = "https://script.google.com/macros/s/AKfycbyGqoqBpUMbf34qt3cMBbvlsCuf-PXqK8Dvhv7Vzj4dgzNT9pBJ0-_UHkc-IvnPqZ1Y/exec";
const PAGE_SIZE = 500;

let page = 1;
let totalPages = 1;
let totalRows = 0;

let resultados = Array(9).fill("");
let marcadores = Array(9).fill("");

const $ = (id) => document.getElementById(id);
function norm(v){ return String(v ?? "").trim().toUpperCase(); }

function showLoading(on){ $("loadingMsg").hidden = !on; }
function showNoMatch(on){ $("noMatchMsg").hidden = !on; }

function syncScrollbarWidth(){
  const box = $("listBox");
  if (!box) return;
  const sbw = box.offsetWidth - box.clientWidth;
  document.documentElement.style.setProperty("--sbw", sbw + "px");
}
window.addEventListener("resize", syncScrollbarWidth, {passive:true});

function setPageText(){
  $("pageTxt").textContent = `P√°gina ${page} / ${totalPages}`;
  $("totalTxt").textContent = `${Number(totalRows||0).toLocaleString("es-MX")} registros`;

  $("btnPrev").disabled = (page <= 1);
  $("btnNext").disabled = (page >= totalPages);
}

function renderPartidos(cfg){
  const partidos = (cfg.partidos || []).slice(0,9);
  const box = $("partidosTxt");
  box.innerHTML = "";

  partidos.forEach((p,i)=>{
    const m = (marcadores[i] && String(marcadores[i]).trim()) ? String(marcadores[i]).trim() : "-";
    const r = (resultados[i] && String(resultados[i]).trim()) ? String(resultados[i]).trim().toUpperCase() : "-";

    const div = document.createElement("div");
    div.className = "p";
    div.innerHTML = `
      <span class="left">${i+1} ${p.local} vs ${p.visita}</span>
      <span class="right">
        <span class="chip">${m}</span>
        <span class="chip pick">${r}</span>
      </span>
    `;
    box.appendChild(div);
  });
}

async function loadConfig(){
  try{
    const res = await fetch(`${BASE}?mode=config`, {cache:"no-store"});
    const j = await res.json();
    const cfg = (j && j.cfg) ? j.cfg : {};

    $("weekTxt").textContent = cfg.subtitulo || "";

    resultados = (cfg.resultados || []).slice(0,9).map(norm);
    marcadores = (cfg.marcadores || []).slice(0,9);

    renderPartidos(cfg);
  }catch(e){}
}

function currentQuery(){
  return $("searchInput").value.trim();
}

// Detecta columnas reales del backend (para no volver a ‚Äúcorrer‚Äù datos)
function computeIndexes(headers){
  const h = (headers || []).map(x => String(x||"").toLowerCase());
  const iF = h.indexOf("folio");
  const iT = h.indexOf("telefono_envio"); // puede existir o no
  const iN = h.indexOf("nombre");
  const iA = h.indexOf("aciertos");
  const iL = h.indexOf("lugar"); // opcional
  return {iF,iT,iN,iA,iL,h};
}

function renderRows(dataObj){
  const list = $("list");
  list.innerHTML = "";

  const headers = (dataObj && dataObj.headers) ? dataObj.headers : [];
  const rows = (dataObj && dataObj.rows) ? dataObj.rows : [];
  const {iF,iT,iN,iA,iL} = computeIndexes(headers);

  if (rows.length === 0){
    syncScrollbarWidth();
    return;
  }

  const parts = [];
  for (let i=0; i<rows.length; i++){
    const r = rows[i] || [];

    const folio = (iF>=0 ? r[iF] : r[0]) ?? "";
    const nombre = (iN>=0 ? r[iN] : r[1]) ?? "";
    const aciertos = (iA>=0 ? r[iA] : r[r.length-1]) ?? "";

    // lugar (si viene)
    const lugar = (iL>=0 ? Number(r[iL]||0) : 0);
    const cls = (lugar===1) ? "row win1" : (lugar===2) ? "row win2" : "row";

    // selecciones: tomamos 9 despu√©s de nombre, ignorando tel si existe
    // buscamos el primer √≠ndice despu√©s de nombre:
    const startSel = iN >= 0 ? (iN + 1) : 2;

    // el final es antes de aciertos/lugar
    const endSel = (iA >= 0 ? iA : (r.length-1));
    const sels = r.slice(startSel, endSel).slice(0,9);

    let selsHtml = "";
    for (let k=0; k<9; k++){
      const s = sels[k] ?? "";
      const ok = resultados[k] && norm(s) === resultados[k];
      selsHtml += `<div style="text-align:center"><span class="pill ${ok?'hit':''}">${(s||'-')}</span></div>`;
    }

    parts.push(`
      <div class="${cls}">
        <div class="gridRow">
          <div class="folio">${folio}</div>
          <div class="name">${nombre}</div>
          ${selsHtml}
          <div class="ac">${aciertos}</div>
        </div>
      </div>
    `);
  }

  list.innerHTML = parts.join("");
  syncScrollbarWidth();
}

async function loadPage(){
  showLoading(true);
  showNoMatch(false);

  try{
    const q = currentQuery();
    const url =
      `${BASE}?mode=clasif&page=${encodeURIComponent(page)}&pageSize=${encodeURIComponent(PAGE_SIZE)}`
      + (q ? `&q=${encodeURIComponent(q)}` : "");

    const res = await fetch(url, {cache:"no-store"});
    const j = await res.json();

    const data = j.data || {};
    totalPages = Number(data.totalPages || 1);
    totalRows  = Number(data.totalRows || 0);
    page = Number(data.page || page);

    const rows = data.rows || [];
    showNoMatch(!!q && rows.length === 0);

    renderRows(data);
    setPageText();
  }catch(e){
    showNoMatch(!!currentQuery());
  }finally{
    showLoading(false);
  }
}

/* navegaci√≥n */
$("btnPrev").addEventListener("click", ()=>{
  if (page<=1) return;
  page--; loadPage();
});
$("btnNext").addEventListener("click", ()=>{
  if (page>=totalPages) return;
  page++; loadPage();
});

/* Enter oculta teclado */
$("searchInput").addEventListener("keydown", (e)=>{
  if (e.key === "Enter"){
    e.preventDefault();
    e.target.blur();
  }
});

/* b√∫squeda (debounce) */
let searchTO = null;
$("searchInput").addEventListener("input", ()=>{
  if (searchTO) clearTimeout(searchTO);
  searchTO = setTimeout(()=>{
    page = 1;
    loadPage();
  }, 180);
});

/* init */
(async ()=>{
  await loadConfig();
  await loadPage();
  setTimeout(syncScrollbarWidth, 0);
})();
</script>

</body>
</html>
