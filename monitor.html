<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="format-detection" content="telephone=no,date=no,email=no,address=no" />
<title>Quiniela Azteca ‚Äì Clasificaci√≥n</title>

<style>
  :root{
    --bg:#eef6f1;
    --card:#ffffff;
    --line:#cfe5da;
    --line2:#e2eee8;
    --text:#0f172a;
    --muted:#64748b;

    --hit:#16a34a; /* verde sem√°foro */
    --hitBorder:#0f7a36;

    /* columnas (ajustables sin romper alineaci√≥n) */
    --wFolio: 64px;
    --wAci:   40px;
    --wSel:   32px; /* cada partido */
    --sbw: 0px; /* scrollbar width (sync JS) */
  }

  *{ box-sizing:border-box; }
  html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
    overflow-x:hidden; /* evita ‚Äúhueco‚Äù lateral */
  }
  a, a:visited{ color:inherit; text-decoration:none; }

  /* Layout general */
  .app{
    min-height:100vh;
    display:flex;
    flex-direction:column;
  }

  /* Header sticky superior (t√≠tulo + partidos + buscador + nav + encabezado 1..9) */
  .top{
    position:sticky;
    top:0;
    z-index:50;
    background:rgba(238,246,241,.92);
    backdrop-filter: blur(8px);
    border-bottom:1px solid var(--line);
  }

  .topInner{
    padding:10px 10px 8px;
    max-width: 980px;
    margin:0 auto;
  }

  .titleRow{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:10px;
    margin-bottom:6px;
  }

  .title{
    font-weight:900;
    letter-spacing:.2px;
    font-size:18px;
    line-height:1.1;
  }
  .week{
    font-weight:800;
    color:var(--muted);
    font-size:13px;
    line-height:1.1;
  }

  /* Partidos */
  .partidosCard{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:18px;
    overflow:hidden;
    box-shadow:0 10px 24px rgba(2,6,23,.05);
    margin:8px 0 10px;
  }
  .p{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:7px 10px;
    border-bottom:1px solid rgba(207,229,218,.65);
    font-size:12px;
    line-height:1.15;
  }
  .p:last-child{ border-bottom:none; }

  .p .left{
    font-weight:800;
    color:#0b1220;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    text-decoration:none !important; /* por si alg√∫n navegador insiste */
  }
  .p .right{ display:flex; gap:6px; align-items:center; flex:0 0 auto; }

  .chip{
    padding:4px 9px;
    border-radius:999px;
    border:2px solid rgba(148,163,184,.35);
    background:#f8fafc;
    font-weight:900;
    font-size:12px;
    min-width:44px;
    text-align:center;
  }
  .chip.pick{
    border-color:rgba(34,197,94,.25);
    background:rgba(34,197,94,.10);
    color:#065f46;
    min-width:38px;
  }

  /* Buscador + nav */
  .controls{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .search{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:22px;
    padding:10px 12px;
    display:flex;
    align-items:center;
    gap:10px;
    box-shadow:0 10px 24px rgba(2,6,23,.04);
  }
  .search .icon{
    font-size:18px;
    opacity:.65;
  }
  .search input{
    border:none;
    outline:none;
    width:100%;
    font-size:16px;
    font-weight:800;
    background:transparent;
    color:var(--text);
  }
  .search input::placeholder{
    color:#6b7280;
    font-weight:800;
  }

  .navCard{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:22px;
    padding:10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    box-shadow:0 10px 24px rgba(2,6,23,.04);
  }
  .navText{
    font-weight:900;
    font-size:18px;
    color:#0f172a;
    line-height:1.05;
  }
  .navText small{
    display:block;
    font-size:12px;
    font-weight:800;
    color:var(--muted);
    margin-top:2px;
  }
  .navBtns{
    display:flex;
    gap:10px;
    align-items:center;
  }
  .btn{
    width:58px;
    height:48px;
    border-radius:18px;
    border:2px solid rgba(148,163,184,.35);
    background:#fff;
    font-size:26px;
    font-weight:900;
    line-height:1;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
    user-select:none;
  }
  .btn:disabled{
    opacity:.35;
  }

  /* Encabezado de tabla fijo (Folio/Nombre + 1..9 + Ac) */
  .tableHead{
    margin-top:10px;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:22px;
    overflow:hidden;
    box-shadow:0 10px 24px rgba(2,6,23,.04);
  }
  .tableHeadGrid{
    display:grid;
    grid-template-columns: var(--wFolio) 1fr repeat(9, var(--wSel)) var(--wAci);
    gap:0;
    padding-right: var(--sbw); /* compensa scrollbar del listado */
    align-items:stretch;
  }
  .th{
    padding:10px 8px;
    border-right:1px solid rgba(207,229,218,.7);
    font-weight:900;
    font-size:12px;
    color:#0b1220;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#f6fbf8;
  }
  .th.left{
    justify-content:flex-start;
    padding-left:12px;
    font-size:13px;
  }
  .th:last-child{ border-right:none; }

  /* Contenedor del listado (scroll) */
  .listWrap{
    flex:1 1 auto;
    max-width:980px;
    width:100%;
    margin:0 auto;
    padding:10px 10px 18px;
    overflow:hidden;
  }
  .listBox{
    height:calc(100vh - 520px); /* fallback; JS ajusta si hace falta */
    max-height:calc(100vh - 520px);
    overflow:auto;
    border-radius:22px;
    background:var(--card);
    border:1px solid var(--line);
    box-shadow:0 10px 24px rgba(2,6,23,.05);
  }

  /* Filas */
  .row{
    display:grid;
    grid-template-columns: var(--wFolio) 1fr repeat(9, var(--wSel)) var(--wAci);
    align-items:center;
    gap:0;
    border-bottom:1px solid rgba(226,238,232,.9);
    min-height:54px;
    padding-right:0;
  }
  .row:last-child{ border-bottom:none; }

  /* 1¬∞ y 2¬∞ en grises */
  .row.win1{ background:#f3f4f6; }
  .row.win2{ background:#e5e7eb; }

  .cell{
    padding:10px 8px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    font-size:14px;
    color:#0b1220;
  }
  .cell.folio{
    justify-content:flex-start;
    padding-left:12px;
    color:#334155;
    font-size:13px;
    font-weight:900;
  }
  .cell.name{
    justify-content:flex-start;
    font-size:18px;
    font-weight:1000;
    letter-spacing:.2px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* Selecciones como ‚Äúpastilla‚Äù compacta */
  .pill{
    width:30px;
    height:30px;
    border-radius:999px;
    display:flex;
    align-items:center;
    justify-content:center;
    border:2px solid rgba(148,163,184,.35);
    background:#fff;
    font-size:15px;
    font-weight:1000;
  }
  .pill.hit{
    background:var(--hit);
    border-color:var(--hitBorder);
    color:#fff;
  }

  /* Aciertos: n√∫mero simple (sin c√≠rculo) */
  .cell.ac{
    justify-content:center;
    font-size:18px;
    font-weight:1000;
    color:#0f172a;
  }
  .cell.ac.good{
    color:var(--hit); /* verde sem√°foro */
  }

  /* Mensajes */
  .msg{
    padding:14px 12px;
    color:#475569;
    font-weight:800;
    font-size:14px;
  }
  .msg.center{ text-align:center; }

  /* Quita subrayados ‚Äúraros‚Äù (Android a veces subraya texto clicable) */
  .p, .p *{ text-decoration:none !important; }

  /* Responsivo: en pantallas muy angostas compactamos sin romper */
  @media (max-width:420px){
    :root{
      --wFolio: 58px;
      --wSel: 30px;
      --wAci: 36px;
    }
    .cell.name{ font-size:17px; }
    .pill{ width:28px; height:28px; font-size:14px; }
    .btn{ width:54px; height:46px; border-radius:18px; }
    .navText{ font-size:17px; }
  }
</style>
</head>

<body>
<div class="app">

  <div class="top" id="topBar">
    <div class="topInner">

      <div class="titleRow">
        <div>
          <div class="title">QUINIELA AZTECA</div>
          <div class="week" id="weekTxt">‚Äî</div>
        </div>
      </div>

      <div class="partidosCard" id="partidosCard">
        <div id="partidosTxt"></div>
      </div>

      <div class="controls">
        <div class="search">
          <div class="icon">üîé</div>
          <input id="searchInput" type="text" inputmode="search"
                 placeholder="Busca aqu√≠ por tel√©fono, nombre o folio" autocomplete="off" />
        </div>

        <div class="navCard">
          <div class="navText" id="navText">
            P√°gina 1 / 1
            <small id="totalTxt">0 registros</small>
          </div>
          <div class="navBtns">
            <button class="btn" id="btnPrev" aria-label="Anterior">‚Äπ</button>
            <button class="btn" id="btnNext" aria-label="Siguiente">‚Ä∫</button>
          </div>
        </div>

        <div class="tableHead">
          <div class="tableHeadGrid" id="headGrid">
            <div class="th left">#</div>
            <div class="th left">Nombre</div>
            <div class="th">1</div><div class="th">2</div><div class="th">3</div><div class="th">4</div><div class="th">5</div>
            <div class="th">6</div><div class="th">7</div><div class="th">8</div><div class="th">9</div>
            <div class="th">Ac</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="listWrap">
    <div class="listBox" id="listBox">
      <div class="msg center" id="loadingMsg">Cargando‚Ä¶</div>
      <div id="list"></div>
      <div class="msg center" id="noMatchMsg" hidden>No hay coincidencias.</div>
    </div>
  </div>

</div>

<script>
const BASE = "https://script.google.com/macros/s/AKfycbyGqoqBpUMbf34qt3cMBbvlsCuf-PXqK8Dvhv7Vzj4dgzNT9pBJ0-_UHkc-IvnPqZ1Y/exec";
const PAGE_SIZE = 500;

let page = 1;
let totalPages = 1;
let totalRows = 0;

let resultados = Array(9).fill(""); // L/E/V para colorear aciertos
let marcadores = Array(9).fill("");

const $ = (id) => document.getElementById(id);

function showLoading(on){ $("loadingMsg").hidden = !on; }
function showNoMatch(on){ $("noMatchMsg").hidden = !on; }
function norm(v){ return String(v ?? "").trim().toUpperCase(); }

function setNavText(){
  $("navText").firstChild.nodeValue = `P√°gina ${page} / ${totalPages}`;
  $("totalTxt").textContent = `${Number(totalRows||0).toLocaleString("es-MX")} registros`;

  $("btnPrev").disabled = (page <= 1);
  $("btnNext").disabled = (page >= totalPages);
}

function syncScrollbarWidth(){
  const box = $("listBox");
  if (!box) return;
  const sbw = box.offsetWidth - box.clientWidth;
  document.documentElement.style.setProperty("--sbw", sbw + "px");
}

function fitListHeight(){
  // Ajusta el alto del listado para que no haya ‚Äúhuecos raros‚Äù
  const top = $("topBar");
  const list = $("listBox");
  if (!top || !list) return;
  const topH = top.getBoundingClientRect().height;
  const h = Math.max(220, window.innerHeight - topH - 18);
  list.style.height = h + "px";
  list.style.maxHeight = h + "px";
  syncScrollbarWidth();
}

window.addEventListener("resize", ()=>{ fitListHeight(); }, {passive:true});

function renderPartidos(cfg){
  const partidos = (cfg.partidos || []).slice(0,9);
  const box = $("partidosTxt");
  box.innerHTML = "";

  partidos.forEach((p,i)=>{
    const m = (marcadores[i] && String(marcadores[i]).trim()) ? String(marcadores[i]).trim() : "-";
    const r = (resultados[i] && String(resultados[i]).trim()) ? String(resultados[i]).trim().toUpperCase() : "-";

    const div = document.createElement("div");
    div.className = "p";
    div.innerHTML = `
      <span class="left">${i+1} ${p.local} vs ${p.visita}</span>
      <span class="right">
        <span class="chip">${m}</span>
        <span class="chip pick">${r}</span>
      </span>
    `;
    box.appendChild(div);
  });
}

async function loadConfig(){
  try{
    const res = await fetch(`${BASE}?mode=config`, {cache:"no-store"});
    const j = await res.json();
    const cfg = (j && j.cfg) ? j.cfg : {};

    $("weekTxt").textContent = cfg.subtitulo || "";

    resultados = (cfg.resultados || []).slice(0,9).map(norm);
    marcadores = (cfg.marcadores || []).slice(0,9);

    renderPartidos(cfg);
  }catch(e){
    // si falla, no rompemos UI
  }
}

function currentQuery(){
  return $("searchInput").value.trim();
}

function renderRows(data){
  const list = $("list");
  list.innerHTML = "";

  const headers = data.headers || [];
  const rows = data.rows || [];

  // Estructura backend:
  // [folio, telefono_envio, nombre, 1..9, aciertos, lugar]
  const idxFolio = 0;
  const idxTel   = 1; // no se muestra, pero sirve para buscar desde backend
  const idxNom   = 2;

  const hLow = headers.map(h=>String(h||"").toLowerCase());
  const idxAci = hLow.indexOf("aciertos"); // deber√≠a existir
  const idxLugar = hLow.indexOf("lugar");  // deber√≠a existir

  rows.forEach(r=>{
    const folio = r[idxFolio] ?? "";
    const nombre = r[idxNom] ?? "";
    const aciertos = (idxAci>=0 ? r[idxAci] : r[r.length-2]) ?? 0;
    const lugar = (idxLugar>=0 ? r[idxLugar] : r[r.length-1]) ?? 0;

    const cls = (lugar===1) ? "row win1" : (lugar===2) ? "row win2" : "row";

    // selecciones: 9 despu√©s de nombre
    const sels = r.slice(idxNom+1, idxNom+1+9);

    const rowDiv = document.createElement("div");
    rowDiv.className = cls;

    // folio, nombre
    rowDiv.innerHTML = `
      <div class="cell folio">${folio}</div>
      <div class="cell name">${String(nombre).toUpperCase()}</div>
      ${sels.map((s, i)=>{
        const v = norm(s || "-");
        const ok = resultados[i] && v === resultados[i];
        return `<div class="cell"><span class="pill ${ok?'hit':''}">${v||"-"}</span></div>`;
      }).join("")}
      <div class="cell ac ${Number(aciertos)>0?'good':''}">${aciertos}</div>
    `;

    list.appendChild(rowDiv);
  });

  syncScrollbarWidth();
}

async function loadPage(){
  showLoading(true);
  showNoMatch(false);

  try{
    const q = currentQuery();
    const url =
      `${BASE}?mode=clasif&page=${encodeURIComponent(page)}&pageSize=${encodeURIComponent(PAGE_SIZE)}`
      + (q ? `&q=${encodeURIComponent(q)}` : "");

    const res = await fetch(url, {cache:"no-store"});
    const j = await res.json();

    // ‚úÖ IMPORTANTE: el backend manda los datos dentro de j.data
    const data = j && j.data ? j.data : null;
    if (!data) throw new Error("Respuesta sin data");

    totalPages = Number(data.totalPages || 1);
    totalRows  = Number(data.totalRows ?? 0);

    // filas
    const rows = data.rows || [];
    showNoMatch(!!currentQuery() && rows.length === 0);

    renderRows(data);
    setNavText();
    fitListHeight();
  }catch(e){
    // si falla, mostramos sin coincidencias si hab√≠a b√∫squeda
    showNoMatch(!!currentQuery());
  }finally{
    showLoading(false);
  }
}

/* navegaci√≥n */
$("btnPrev").addEventListener("click", ()=>{
  if (page<=1) return;
  page--; loadPage();
});
$("btnNext").addEventListener("click", ()=>{
  if (page>=totalPages) return;
  page++; loadPage();
});

/* Enter oculta teclado */
$("searchInput").addEventListener("keydown", (e)=>{
  if (e.key === "Enter"){
    e.preventDefault();
    e.target.blur();
  }
});

/* b√∫squeda con debounce */
let searchTO = null;
$("searchInput").addEventListener("input", ()=>{
  if (searchTO) clearTimeout(searchTO);
  searchTO = setTimeout(()=>{
    page = 1;
    loadPage();
  }, 200);
});

/* init */
(async ()=>{
  await loadConfig();
  await loadPage();
  setTimeout(()=>{ fitListHeight(); syncScrollbarWidth(); }, 0);
})();
</script>
</body>
</html>
