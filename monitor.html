<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monitor ‚Äì Clasificaci√≥n Quiniela</title>
  <style>
    :root{
      --bg:#f3f6f4;
      --card:#ffffff;
      --fg:#0f172a;
      --muted:#475569;
      --line:#e5e7eb;
      --shadow: 0 10px 24px rgba(2,6,23,.08);
      --focus: rgba(2,132,199,.18);
    }

    *{ box-sizing:border-box; }
    html, body{ overflow-x:hidden; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background: var(--bg);
      color: var(--fg);
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px;
    }

    .top{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .top h1{
      margin:0;
      font-size: 16px;
      letter-spacing:.02em;
    }
    .sub{
      margin-top:2px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }

    .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
      background:#fff;
      white-space:nowrap;
    }
    .dot{ width:8px;height:8px;border-radius:999px;background:#16a34a; }
    .dot.off{ background:#ef4444; }

    .search{
      min-width: 260px;
      max-width: 520px;
      width: min(520px, 92vw);
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
    }
    .search input{
      border:none;
      outline:none;
      width:100%;
      font-size:13px;
      font-weight:800;
      color:var(--fg);
      background:transparent;
    }
    .search:focus-within{
      border-color:#38bdf8;
      box-shadow: 0 0 0 4px var(--focus);
    }
    .search .hint{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      white-space:nowrap;
    }

    .card{
      margin-top: 10px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* üëá vuelve el scroll horizontal */
    .tableWrap{
      width:100%;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 980px; /* fuerza tabla ‚Äútipo sheets‚Äù y permite scroll en m√≥viles */
    }

    thead th{
      position: sticky;
      top: 0;
      z-index: 2;
      background:#f8fafc;
      border-bottom:1px solid var(--line);
      padding:10px 8px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.04em;
      color:#334155;
      font-weight:900;
      text-align:left;
      white-space:nowrap;
    }

    tbody td{
      border-bottom:1px solid var(--line);
      padding:10px 8px;
      font-size:13px;
      font-weight:800;
      vertical-align:top;
      white-space:nowrap; /* como sheets */
    }

    tbody tr:nth-child(odd){ background:#ffffff; }
    tbody tr:nth-child(even){ background:#f9fbfa; }
    tbody tr:last-child td{ border-bottom:none; }

    .err{
      padding:12px;
      color:#b91c1c;
      background:#fff1f2;
      border-top:1px solid #fecdd3;
      font-weight:900;
      font-size:13px;
      display:none;
    }

    .foot{
      padding:10px 12px;
      border-top:1px solid var(--line);
      background:#fff;
      color: var(--muted);
      font-size:12px;
      font-weight:800;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .count{
      font-weight:900;
      color:#0f172a;
    }

    @media (max-width:520px){
      .top{ padding:10px; }
      .top h1{ font-size:15px; }
      tbody td{ font-size:12.5px; }
      .search{ width: 100%; }
      .right{ width:100%; justify-content:space-between; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Monitor ‚Äì Clasificaci√≥n</h1>
        <div class="sub">B√∫squeda por <b>Nombre</b> o <b>Tel√©fono</b> (una sola barra)</div>
      </div>

      <div class="right">
        <div class="search" title="Busca por nombre o tel√©fono">
          <input id="q" placeholder="Buscar: nombre o tel√©fono‚Ä¶" autocomplete="off" />
          <span class="hint" id="qHint">0</span>
        </div>

        <div class="pill" id="statusPill">
          <span class="dot" id="dot"></span>
          <span id="statusTxt">Cargando‚Ä¶</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="tableWrap" id="tableWrap"></div>
      <div class="err" id="errBox"></div>
      <div class="foot">
        <div id="hintTxt">Actualiza autom√°ticamente cada 5 segundos.</div>
        <div><span class="count" id="countTxt">0</span> filas</div>
      </div>
    </div>
  </div>

<script>
  const ENDPOINT   = "https://script.google.com/macros/s/AKfycbyGqoqBpUMbf34qt3cMBbvlsCuf-PXqK8Dvhv7Vzj4dgzNT9pBJ0-_UHkc-IvnPqZ1Y/exec?mode=clasif";
  const REFRESH_MS = 5000;

  const $ = s => document.querySelector(s);

  let LAST_HEADERS = [];
  let LAST_ROWS    = [];

  function setStatus(ok, msg){
    const dot = $('#dot');
    dot.classList.toggle('off', !ok);
    $('#statusTxt').textContent = msg;
  }

  function showErr(msg){
    const box = $('#errBox');
    if (!msg){
      box.style.display = 'none';
      box.textContent = '';
      return;
    }
    box.style.display = 'block';
    box.textContent = msg;
  }

  function esc(s){
    return String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#39;");
  }

  function renderTable(headers, rows){
    const wrap = $('#tableWrap');

    if (!headers?.length){
      wrap.innerHTML = '<div class="foot">No hay encabezados para mostrar.</div>';
      $('#countTxt').textContent = '0';
      $('#qHint').textContent = '0';
      return;
    }

    const ths = headers.map(h => `<th>${esc(h)}</th>`).join('');

    const trs = (rows || []).map(r => {
      const tds = headers.map((_, i) => `<td>${esc(r?.[i])}</td>`).join('');
      return `<tr>${tds}</tr>`;
    }).join('');

    wrap.innerHTML = `
      <table>
        <thead><tr>${ths}</tr></thead>
        <tbody>${trs}</tbody>
      </table>
    `;

    $('#countTxt').textContent = String((rows || []).length);
    $('#qHint').textContent = String((rows || []).length);
  }

  function filterRows(query){
    const q = String(query || '').trim().toUpperCase();
    if (!q) return LAST_ROWS;

    const hLower = LAST_HEADERS.map(h => String(h).toLowerCase().trim());
    const idxTel   = hLower.indexOf('telefono_envio') >= 0 ? hLower.indexOf('telefono_envio')
                  : hLower.indexOf('telefono') >= 0 ? hLower.indexOf('telefono')
                  : -1;
    const idxNom   = hLower.indexOf('nombre');

    // Si no existen columnas clave, no filtramos (fallback)
    if (idxNom < 0 && idxTel < 0) return LAST_ROWS;

    const isDigits = /^\d+$/.test(q);

    return (LAST_ROWS || []).filter(r => {
      const tel = idxTel >= 0 ? String(r[idxTel] ?? '').toUpperCase() : '';
      const nom = idxNom >= 0 ? String(r[idxNom] ?? '').toUpperCase() : '';

      // En la MISMA barra:
      // - Si escribi√≥ solo n√∫meros: filtra por tel√©fono
      // - Si escribi√≥ letras: filtra por nombre (y tambi√©n deja match por tel si pega tel con espacios)
      if (isDigits) return tel.includes(q);
      return nom.includes(q) || tel.includes(q);
    });
  }

  function applySearch(){
    const q = $('#q').value;
    const filtered = filterRows(q);
    renderTable(LAST_HEADERS, filtered);
  }

  async function load(){
    try{
      setStatus(true, 'Cargando‚Ä¶');
      showErr('');

      const res = await fetch(ENDPOINT, { cache: 'no-store' });
      const json = await res.json();

      if (!json || json.ok !== true){
        throw new Error(json?.error || 'Respuesta inv√°lida');
      }

      const data = json.data || {};
      LAST_HEADERS = data.headers || [];
      LAST_ROWS    = data.rows || [];

      // pinta con filtro actual (si el usuario ya estaba buscando, no se pierde)
      applySearch();

      const now = new Date();
      setStatus(true, 'OK ¬∑ ' + now.toLocaleTimeString('es-MX'));
      $('#hintTxt').textContent =
        `Actualiza autom√°ticamente cada ${Math.round(REFRESH_MS/1000)}s. √öltima carga: ${now.toLocaleTimeString('es-MX')}.`;
    } catch(err){
      setStatus(false, 'Error');
      showErr(String(err?.message || err));
    }
  }

  // search events
  $('#q').addEventListener('input', () => applySearch());

  load();
  setInterval(load, REFRESH_MS);
</script>
</body>
</html>
