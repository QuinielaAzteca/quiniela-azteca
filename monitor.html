<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Quiniela Azteca – Clasificación</title>

<style>
  :root{
    --bg:#eef6f1;
    --line:#cfe5da;
    --line2:#e2eee8;
    --txt:#0f172a;
    --muted:#475569;

    --win1:#dcfce7; /* verde suave */
    --win2:#fef9c3; /* amarillo suave */

    --hitBg:#dcfce7;
    --hitBd:#86efac;
    --hitTx:#064e3b;

    --wSel: 22px;
    --wA: 24px;

    --fsRow: 11px;
    --fsSmall: 10px;
    --fsTiny: 9px;
  }

  html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    background:var(--bg);
    color:var(--txt);
  }

  .header{
    position:sticky; top:0; z-index:30;
    background:#fff;
    border-bottom:1px solid var(--line);
    padding:8px 10px 8px;
  }

  .brandRow{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:6px;
  }
  .title{
    margin:0;
    font-weight:1000;
    letter-spacing:.04em;
    line-height:1.05;
    font-size:18px;
  }
  .title .mxg{ color:#0a6b3a; }
  .title .mxr{ color:#c62828; }

  .week{
    font-size:12px;
    font-weight:900;
    color:var(--muted);
    margin-top:2px;
  }

  .partidos{ font-size:11px; line-height:1.15; }
  .p{
    display:flex; justify-content:space-between; gap:8px;
    padding:3px 6px;
    border-radius:10px;
    background:rgba(238,246,241,.6);
    border:1px solid rgba(207,229,218,.65);
    margin-bottom:4px;
  }
  .p .left{
    flex:1;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    font-weight:800;
  }
  .p .right{
    flex-shrink:0;
    display:flex; gap:6px; align-items:center;
    white-space:nowrap;
    color:var(--muted);
    font-weight:900;
    font-size:10px;
  }
  .chip{
    padding:2px 6px;
    border-radius:999px;
    border:1px solid rgba(203,213,225,.9);
    background:#f8fafc;
    color:var(--txt);
  }
  .chip.pick{
    background:#ecfdf5;
    border-color:#bbf7d0;
    color:#065f46;
  }

  .wrap{ padding:8px; }

  /* ✅ Encabezado fijo del grid */
  .headRow{
    position:sticky;
    top: calc(8px + 8px + 0px + env(safe-area-inset-top)); /* pegado bajo el header */
    z-index:25;
    margin-top:8px;
    background:#fff;
    border:1px solid var(--line);
    border-radius:12px;
    overflow:hidden;
  }

  .headGrid{
    display:grid;
    grid-template-columns: 1fr repeat(9, var(--wSel)) var(--wA);
    align-items:stretch;
  }
  .hCell{
    padding:6px 2px;
    border-right:1px solid rgba(207,229,218,.7);
    text-align:center;
    font-weight:1000;
    font-size:10px;
    letter-spacing:.02em;
    background:#f8fafc;
    white-space:nowrap;
  }
  .hCell:first-child{
    text-align:left;
    padding-left:8px;
    font-size:10px;
    color:var(--muted);
    background:#fff;
  }
  .hCell:last-child{ border-right:none; }

  #list{
    margin-top:6px;
    border:1px solid var(--line);
    border-radius:14px;
    overflow:hidden;
    background:#fff;
  }

  .row{
    display:grid;
    grid-template-columns: 1fr repeat(9, var(--wSel)) var(--wA);
    align-items:center;
    border-bottom:1px solid var(--line2);
    font-size:var(--fsRow);
    padding:4px 0;
  }
  .row:last-child{ border-bottom:none; }
  .row.win1{ background:var(--win1); }
  .row.win2{ background:var(--win2); }

  .fn{
    padding-left:8px;
    display:flex;
    align-items:baseline;
    gap:8px;
    min-width:0;
  }
  .folio{
    font-size:var(--fsTiny);
    font-weight:900;
    color:var(--muted);
    flex:0 0 auto;
  }
  .nombre{
    font-size:var(--fsRow);
    font-weight:1000;
    min-width:0;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .selCell, .aCell{
    text-align:center;
    padding:0 1px;
  }

  .selPill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:18px;
    height:20px;
    border-radius:12px;
    border:1px solid rgba(203,213,225,.95);
    background:#fff;
    font-weight:1000;
    font-size:var(--fsSmall);
    line-height:1;
  }
  .selPill.hit{
    background:var(--hitBg);
    border-color:var(--hitBd);
    color:var(--hitTx);
  }

  .aBox{
    display:flex;
    flex-direction:column;
    align-items:center;
    line-height:1;
    gap:1px;
    padding:2px 0;
  }
  .aLab{
    font-size:var(--fsTiny);
    font-weight:1000;
    color:var(--muted);
  }
  .aVal{
    font-size:var(--fsSmall);
    font-weight:1000;
  }

  .loading, .noMatch{
    margin-top:8px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:12px;
    background:#fff;
    color:var(--muted);
    font-weight:900;
    text-align:center;
  }
  .loading[hidden], .noMatch[hidden]{ display:none; }

  .nav{
    display:flex;
    gap:6px;
    justify-content:center;
    align-items:center;
    flex-wrap:wrap;
    margin:10px 0 6px;
  }
  .nav button{
    padding:5px 8px;
    border-radius:10px;
    border:1px solid #cbd5e1;
    background:#fff;
    font-weight:900;
    font-size:12px;
  }
  .nav button[disabled]{ opacity:.45; }

  .pages{
    display:flex;
    gap:6px;
    align-items:center;
    flex-wrap:wrap;
  }
  .pg{
    padding:5px 8px;
    border-radius:10px;
    border:1px solid #cbd5e1;
    background:#fff;
    font-weight:1000;
    font-size:12px;
    min-width:34px;
  }
  .pg.active{
    background:#0f172a;
    color:#fff;
    border-color:#0f172a;
  }
  .dots{
    color:var(--muted);
    font-weight:1000;
    font-size:12px;
    padding:0 2px;
  }

  @media (max-width:420px){
    :root{
      --wSel: 20px;
      --wA: 22px;
      --fsRow: 10px;
      --fsSmall: 9px;
      --fsTiny: 8px;
    }
    .title{ font-size:16px; }
    .nav button, .pg{ font-size:11px; padding:5px 7px; }
    .selPill{ width:16px; height:18px; }
  }
</style>
</head>

<body>

<div class="header">
  <div class="brandRow">
    <div>
      <div class="title"><span class="mxg">QUINIELA</span> <span class="mxr">AZTECA</span></div>
      <div class="week" id="weekTxt"></div>
    </div>
  </div>

  <div class="partidos" id="partidos"></div>
</div>

<div class="wrap">

  <!-- ✅ fila fija -->
  <div class="headRow" aria-hidden="true">
    <div class="headGrid">
      <div class="hCell">Folio / Nombre</div>
      <div class="hCell">1</div><div class="hCell">2</div><div class="hCell">3</div>
      <div class="hCell">4</div><div class="hCell">5</div><div class="hCell">6</div>
      <div class="hCell">7</div><div class="hCell">8</div><div class="hCell">9</div>
      <div class="hCell">A</div>
    </div>
  </div>

  <div class="loading" id="loading" hidden>Cargando…</div>
  <div class="noMatch" id="noMatch" hidden>Sin coincidencias</div>

  <div id="list"></div>

  <div class="nav">
    <button id="btnFirst" onclick="go(1)">Primera</button>
    <button id="btnPrev" onclick="go(page-1)">‹</button>
    <div class="pages" id="pages"></div>
    <button id="btnNext" onclick="go(page+1)">›</button>
    <button id="btnLast" onclick="go(totalPages)">Última</button>
  </div>

</div>

<script>
const BASE = "https://script.google.com/macros/s/AKfycbyGqoqBpUMbf34qt3cMBbvlsCuf-PXqK8Dvhv7Vzj4dgzNT9pBJ0-_UHkc-IvnPqZ1Y/exec";
const PAGE_SIZE = 500;

let page = 1, totalPages = 1;

// Para pintar 1º/2º lugar consistente
let globalMax = null;
let globalSecond = null;

// ✅ Para pintar aciertos (comparar contra resultados de config)
let resultadosCfg = []; // 9

const $ = (id) => document.getElementById(id);

function setLoading(on, txt="Cargando…"){
  const el = $("loading");
  el.textContent = txt;
  el.hidden = !on;
}
function setNoMatch(on){ $("noMatch").hidden = !on; }

function norm(v){ return String(v ?? "").trim().toUpperCase(); }

async function loadConfigOnce(){
  try{
    const r = await fetch(`${BASE}?mode=config`, {cache:"no-store"});
    const j = await r.json();
    const cfg = (j && j.cfg) ? j.cfg : {};

    $("weekTxt").textContent = cfg.subtitulo || "";

    const partidos = (cfg.partidos || []).slice(0,9);
    const resultados = (cfg.resultados || []).slice(0,9);
    const marcadores = (cfg.marcadores || []).slice(0,9);

    resultadosCfg = resultados.map(norm);

    renderPartidos(partidos, resultados, marcadores);
  }catch(e){
    $("weekTxt").textContent = "";
    $("partidos").textContent = "";
    resultadosCfg = [];
  }
}

function renderPartidos(partidos, resultados, marcadores){
  const box = $("partidos");
  box.innerHTML = "";

  for (let i=0; i<9; i++){
    const p = partidos[i] || {local:"", visita:""};
    if (!p.local && !p.visita) continue;

    const m = (marcadores[i] && String(marcadores[i]).trim()) ? String(marcadores[i]).trim() : "-";
    const r = (resultados[i] && String(resultados[i]).trim()) ? String(resultados[i]).trim().toUpperCase() : "-";

    const div = document.createElement("div");
    div.className = "p";
    div.innerHTML = `
      <span class="left">${i+1} ${p.local} vs ${p.visita}</span>
      <span class="right">
        <span class="chip">${m}</span>
        <span class="chip pick">${r}</span>
      </span>
    `;
    box.appendChild(div);
  }
}

function idxOf(headers, name){
  const n = String(name||"").toLowerCase();
  for (let i=0;i<headers.length;i++){
    if (String(headers[i]||"").trim().toLowerCase() === n) return i;
  }
  return -1;
}

function computeGlobalPlacesFromSorted(rows, iA){
  if (!rows || !rows.length) return;
  const first = Number(rows[0][iA] || 0);
  if (globalMax == null) globalMax = first;

  if (globalSecond == null){
    for (let i=0; i<rows.length; i++){
      const v = Number(rows[i][iA] || 0);
      if (v < globalMax){ globalSecond = v; break; }
    }
  }
}

async function load(){
  setLoading(true, "Cargando…");
  setNoMatch(false);

  try{
    const res = await fetch(`${BASE}?mode=clasif&page=${page}&pageSize=${PAGE_SIZE}`, {cache:"no-store"});
    const j = await res.json();
    const d = j && j.data ? j.data : null;
    if (!d){
      $("list").innerHTML = "";
      setLoading(false);
      return;
    }

    totalPages = Number(d.totalPages || 1);
    page = Number(d.page || page);

    const headers = d.headers || [];
    const rows = d.rows || [];

    const iF = idxOf(headers, "folio");
    const iN = idxOf(headers, "nombre");
    const iA = idxOf(headers, "aciertos");

    if (iF < 0 || iN < 0 || iA < 0){
      renderFallback(rows);
      renderNav();
      setLoading(false);
      return;
    }

    // 9 selecciones después de nombre
    const startSel = iN + 1;

    computeGlobalPlacesFromSorted(rows, iA);

    render(rows, iF, iN, iA, startSel);
    renderNav();

  }catch(e){
    $("list").innerHTML = "";
  } finally {
    setLoading(false);
  }
}

function render(rows, iF, iN, iA, startSel){
  const list = $("list");
  list.innerHTML = "";

  if (!rows || rows.length === 0){
    setNoMatch(true);
    return;
  }

  for (let idx=0; idx<rows.length; idx++){
    const r = rows[idx] || [];

    const folio = r[iF] ?? "";
    const nombre = r[iN] ?? "";
    const ac = Number(r[iA] ?? 0);

    let cls = "row";
    if (globalMax != null && ac === globalMax) cls += " win1";
    else if (globalSecond != null && ac === globalSecond) cls += " win2";

    let selsHtml = "";
    for (let k=0; k<9; k++){
      const v = r[startSel + k] ?? "";
      const vN = norm(v);
      const ok = resultadosCfg[k] && vN === resultadosCfg[k];

      selsHtml += `
        <div class="selCell">
          <span class="selPill ${ok ? "hit" : ""}">${v ? String(v) : "-"}</span>
        </div>`;
    }

    const aHtml = `
      <div class="aCell">
        <div class="aBox">
          <div class="aLab">A</div>
          <div class="aVal">${r[iA] ?? ""}</div>
        </div>
      </div>`;

    const div = document.createElement("div");
    div.className = cls;
    div.innerHTML = `
      <div class="fn">
        <span class="folio">${folio}</span>
        <span class="nombre">${nombre}</span>
      </div>
      ${selsHtml}
      ${aHtml}
    `;
    list.appendChild(div);
  }
}

function renderFallback(rows){
  const list = $("list");
  list.innerHTML = "";

  if (!rows || rows.length === 0){
    setNoMatch(true);
    return;
  }

  for (const r of rows){
    const div = document.createElement("div");
    div.className = "row";
    div.innerHTML = `
      <div class="fn">
        <span class="folio">${(r[0] ?? "")}</span>
        <span class="nombre">${(r[1] ?? "")}</span>
      </div>
      ${Array.from({length:9}).map((_,k)=>`
        <div class="selCell"><span class="selPill">${(r[2+k] ?? "-")}</span></div>
      `).join("")}
      <div class="aCell">
        <div class="aBox"><div class="aLab">A</div><div class="aVal">${(r[11] ?? "")}</div></div>
      </div>
    `;
    list.appendChild(div);
  }
}

function makePageButtons(current, total){
  const out = [];
  const add = (x) => out.push({t:String(x), p:x, type:"page"});
  const dots = () => out.push({t:"…", type:"dots"});

  if (total <= 10){
    for (let i=1; i<=total; i++) add(i);
    return out;
  }

  add(1);
  if (current > 4) dots();

  const start = Math.max(2, current - 2);
  const end = Math.min(total - 1, current + 2);

  for (let i=start; i<=end; i++) add(i);

  if (current < total - 3) dots();
  add(total);

  return out;
}

function renderNav(){
  $("btnFirst").disabled = (page <= 1);
  $("btnPrev").disabled  = (page <= 1);
  $("btnNext").disabled  = (page >= totalPages);
  $("btnLast").disabled  = (page >= totalPages);

  const box = $("pages");
  box.innerHTML = "";

  const items = makePageButtons(page, totalPages);

  for (const it of items){
    if (it.type === "dots"){
      const s = document.createElement("span");
      s.className = "dots";
      s.textContent = it.t;
      box.appendChild(s);
      continue;
    }
    const b = document.createElement("button");
    b.className = "pg" + (it.p === page ? " active" : "");
    b.textContent = it.t;
    b.onclick = () => go(it.p);
    box.appendChild(b);
  }
}

function go(p){
  p = Number(p);
  if (!isFinite(p)) return;
  if (p < 1 || p > totalPages) return;
  page = p;
  window.scrollTo({top: 0, behavior: "auto"});
  load();
}

(async function init(){
  await loadConfigOnce();
  await load();
})();
</script>
</body>
</html>
