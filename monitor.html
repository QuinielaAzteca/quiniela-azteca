<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiniela Azteca ‚Äì Monitor</title>

<style>
  html, body { height: 100%; }
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:#eaf3ee;
    color:#0f172a;
    overflow:hidden; /* ‚úÖ solo scrollea el listado */
  }

  :root{
    --line:#d7e6dc;
    --card:#ffffff;
    --rowA:#f6fbf8;
    --rowB:#eff7f2;

    --l:#0a6b3a;   /* verde */
    --v:#c62828;   /* rojo  */

    --chipBg:#f8fafc;
    --chipBd:#e5e7eb;
    --chipFg:#0f172a;

    --okBg:#ecfdf5;
    --okBd:#bbf7d0;
    --okFg:#065f46;

    --pillBorder:#cbd5e1;
    --pillHitBg:#dcfce7;
    --pillHitBd:#86efac;
    --pillHitTx:#064e3b;

    --azul1:#1d4ed8;   /* 1er */
    --azul2:#93c5fd;   /* 2do */
  }

  /* ====== BLOQUE FIJO ARRIBA ====== */
  .fixed{
    position:sticky;
    top:0;
    z-index:50;
    background:rgba(255,255,255,.92);
    backdrop-filter: blur(8px);
    border-bottom:1px solid rgba(215,230,220,.9);
  }

  .fixedInner{
    max-width:1100px;
    margin:0 auto;
    padding:6px 8px; /* ‚úÖ compacto */
  }

  .brand{
    display:flex;
    flex-direction:column;
    gap:2px; /* ‚úÖ compacto */
  }
  .title{
    font-weight:1000;
    letter-spacing:.04em;
    line-height:1;
    font-size:16px; /* ‚úÖ compacto */
  }
  .title .mxg{ color:#006847; }
  .title .mxr{ color:#ce1126; }
  .week{
    font-size:11px; /* ‚úÖ compacto */
    font-weight:900;
    color:#475569;
  }

  /* ====== CARD PARTIDOS ====== */
  .card{
    margin-top:6px; /* ‚úÖ compacto */
    background: linear-gradient(180deg, #ffffff 0%, #fbfdfc 100%);
    border:1px solid var(--line);
    border-radius:12px;
    overflow:hidden;
    box-shadow: 0 10px 24px rgba(2, 44, 20, .08);
  }
  .bar{
    height:6px; /* ‚úÖ compacto */
    background:linear-gradient(90deg, var(--l) 0%, var(--l) 33%, #ffffff 33%, #ffffff 66%, var(--v) 66%, var(--v) 100%);
  }
  .inner{
    padding:6px 8px; /* ‚úÖ compacto */
  }
  .matches{
    display:flex;
    flex-direction:column;
    gap:4px; /* ‚úÖ compacto */
  }
  .matchLine{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    padding:4px 6px; /* ‚úÖ compacto */
    border-radius:10px;
    background: var(--rowA);
    border:1px solid rgba(215,230,220,.6);
  }
  .matchLine:nth-child(even){ background: var(--rowB); }
  .matchLeft{
    flex:1;
    min-width:0;
    font-weight:1000;
    font-size:11.5px; /* ‚úÖ compacto */
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .matchLeft b{ font-weight:1000; }
  .matchRight{
    display:flex;
    align-items:center;
    gap:6px;
    flex-shrink:0;
  }
  .chip{
    padding:3px 8px; /* ‚úÖ compacto */
    border-radius:999px;
    border:1px solid var(--chipBd);
    background: var(--chipBg);
    font-size:11px; /* ‚úÖ compacto */
    font-weight:1000;
    color: var(--chipFg);
    white-space:nowrap;
    box-shadow:none; /* ‚úÖ compacto */
  }
  .chip.pick{
    background: var(--okBg);
    border-color: var(--okBd);
    color: var(--okFg);
  }

  /* ====== BUSCADOR ====== */
  .search{
    margin-top:6px; /* ‚úÖ compacto */
    position:relative;
  }
  .search::before{
    content:"üîç";
    position:absolute;
    left:10px;
    top:50%;
    transform:translateY(-50%);
    font-size:14px;
    opacity:.75;
  }
  .search input{
    width:100%;
    padding:8px 10px 8px 36px; /* ‚úÖ compacto */
    font-size:13px; /* ‚úÖ compacto */
    font-weight:900;
    border:2px solid #cbd5e1; /* ‚úÖ compacto */
    border-radius:14px;
    outline:none;
    background:#fff;
  }
  .search input:focus{ border-color:#94a3b8; }

  /* ====== CABECERA DE TABLA (FIJA) ====== */
  .tableHeadBox{
    margin-top:6px; /* ‚úÖ compacto */
    background:#fff;
    border:1px solid var(--line);
    border-bottom:none;
    border-radius:12px 12px 0 0;
    overflow:hidden;
    box-shadow: 0 10px 24px rgba(2, 44, 20, .08);
  }
  .tableHead{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    table-layout:fixed;
  }
  .tableHead th{
    background:#f8fafc;
    border-bottom:1px solid var(--line);
    padding:5px 4px; /* ‚úÖ compacto */
    font-size:10px;  /* ‚úÖ compacto */
    letter-spacing:.04em;
    font-weight:1000;
    text-align:center;
    white-space:nowrap;
  }
  .tableHead th.col-folio{ width:28px; font-size:10px; }
  .tableHead th.col-nombre{ width:170px; text-align:left; }

  .tableHead th.col-ac{ width:34px; }

  /* ====== LISTADO SCROLL ====== */
  .wrap{
    max-width:1100px;
    margin:0 auto;
    padding:0 8px 10px; /* ‚úÖ compacto */
  }

  .tableScroll{
    background:#fff;
    border:1px solid var(--line);
    border-top:none;
    border-radius:0 0 12px 12px;
    overflow:auto;
    box-shadow: 0 10px 24px rgba(2, 44, 20, .08);

    /* ‚úÖ el listado ocupa m√°s pantalla */
    max-height: calc(100vh - 220px);
  }

  table#tablaBody{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    table-layout:fixed;
  }
  #tablaBody td{
    border-bottom:1px solid var(--line);
    padding:4px 4px; /* ‚úÖ compacto */
    font-size:13px;
    font-weight:1000;
    text-align:center;
    vertical-align:middle;
    background:#fff;
  }
  #tablaBody tr:nth-child(even) td{ background:#fbfdff; }
  #tablaBody tr:last-child td{ border-bottom:none; }

  td.col-folio{
    width:28px;
    font-size:10px; /* ‚úÖ compacto */
    color:#64748b;
    text-align:right;
  }
  td.col-nombre{
    width:170px;
    text-align:left;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  td.selCell{ padding:3px 0; }

  .selPill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:20px;
    height:24px;
    border-radius:12px;
    border:1px solid var(--pillBorder);
    font-weight:1000;
    font-size:12px;
    line-height:1;
    background:#fff;
  }
  .selPill.hit{
    background:var(--pillHitBg);
    border-color:var(--pillHitBd);
    color:var(--pillHitTx);
  }

  td.col-ac{
    width:34px;
    font-size:12px;
    font-weight:1000;
  }
  td.col-ac.win1{ background:var(--azul1) !important; color:#fff; }
  td.col-ac.win2{ background:var(--azul2) !important; color:#0f172a; }

  /* responsive */
  @media (max-width:520px){
    .tableHead th.col-nombre, td.col-nombre{ width:160px; }
    .tableScroll{ max-height: calc(100vh - 210px); }
  }
  @media (max-width:420px){
    .tableHead th.col-nombre, td.col-nombre{ width:150px; }
    .selPill{ width:18px; height:22px; font-size:11px; }
    .tableScroll{ max-height: calc(100vh - 205px); }
  }
</style>
</head>

<body>

<!-- ===== BLOQUE FIJO (TODO JUNTO) ===== -->
<div class="fixed">
  <div class="fixedInner">

    <div class="brand">
      <div class="title">
        <span class="mxg">QUINIELA</span> <span class="mxr">AZTECA</span>
      </div>
      <div class="week" id="weekTxt">‚Äî</div>
    </div>

    <!-- Partidos -->
    <div class="card">
      <div class="bar"></div>
      <div class="inner">
        <div class="matches" id="matches">
          <div style="font-weight:900;color:#475569;font-size:12px;">Cargando partidos‚Ä¶</div>
        </div>
      </div>
    </div>

    <!-- Buscador -->
    <div class="search">
      <input id="searchInput" placeholder="Busca por tel√©fono, nombre o folio" autocomplete="off" />
    </div>

    <!-- Cabecera fija de la tabla (la fila # Nombre 1..9 A) -->
    <div class="tableHeadBox">
      <table class="tableHead" id="tablaHead">
        <thead>
          <tr>
            <th class="col-folio">#</th>
            <th class="col-nombre">Nombre</th>
            <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th>
            <th class="col-ac">A</th>
          </tr>
        </thead>
      </table>
    </div>

  </div>
</div>

<!-- ===== LISTADO (SOLO ESTO HACE SCROLL) ===== -->
<div class="wrap">
  <div class="tableScroll">
    <table id="tablaBody"></table>
  </div>
</div>

<script>
  const BASE = "https://script.google.com/macros/s/AKfycbyGqoqBpUMbf34qt3cMBbvlsCuf-PXqK8Dvhv7Vzj4dgzNT9pBJ0-_UHkc-IvnPqZ1Y/exec";
  const ENDPOINT = BASE + "?mode=clasif";
  const CONFIG   = BASE + "?mode=config";
  const REFRESH_MS = 5000;

  let rawAll = [];
  let resultados = [];
  let marcadores = [];
  let partidos = [];

  const $ = (id) => document.getElementById(id);

  const norm = (v) => String(v ?? "").trim().toUpperCase();

  function computePlaces(rows){
    const acs = rows.map(r => Number(r.aciertos)||0);
    const max = Math.max(...acs, 0);
    const uniq = [...new Set(acs)].sort((a,b)=>b-a);

    let second = null;
    for (const a of uniq){
      if (a < max){ second = a; break; }
    }

    rows.forEach(r=>{
      const a = Number(r.aciertos)||0;
      r._lugar = (a===max) ? 1 : (second!=null && a===second ? 2 : 0);
    });
  }

  function renderMatches(){
    const wrap = $("matches");
    if (!wrap) return;

    if (!partidos || !partidos.length){
      wrap.innerHTML = `<div style="font-weight:900;color:#475569;font-size:12px;">No hay partidos en config.</div>`;
      return;
    }

    wrap.innerHTML = partidos.slice(0,9).map((p,i)=>{
      const m = (marcadores[i] && String(marcadores[i]).trim()) ? String(marcadores[i]).trim() : "‚Äî";
      const r = (resultados[i] && String(resultados[i]).trim()) ? String(resultados[i]).trim().toUpperCase() : "‚Äî";

      return `
        <div class="matchLine">
          <div class="matchLeft"><b>${i+1}</b> ${p.local} vs ${p.visita}</div>
          <div class="matchRight">
            <span class="chip">${m}</span>
            <span class="chip pick">${r}</span>
          </div>
        </div>
      `;
    }).join("");
  }

  function renderTable(rows){
    const table = $("tablaBody");
    if (!table) return;

    // colgroup para que alinee perfecto con la cabecera fija
    const colgroup = `
      <colgroup>
        <col style="width:28px">
        <col style="width:170px">
        ${Array.from({length:9}).map(()=>`<col>`).join("")}
        <col style="width:34px">
      </colgroup>
    `;

    const tbody = rows.map(r=>{
      const selsHtml = r.sels.map((s,i)=>{
        const ok = resultados[i] && norm(s) === norm(resultados[i]);
        return `<td class="selCell"><span class="selPill ${ok?'hit':''}">${s || '-'}</span></td>`;
      }).join("");

      const acClass = (r._lugar===1) ? "win1" : (r._lugar===2) ? "win2" : "";

      return `
        <tr>
          <td class="col-folio">${r.folio ?? ''}</td>
          <td class="col-nombre">${r.nombre_show ?? ''}</td>
          ${selsHtml}
          <td class="col-ac ${acClass}">${r.aciertos ?? ''}</td>
        </tr>
      `;
    }).join("");

    table.innerHTML = colgroup + `<tbody>${tbody}</tbody>`;
  }

  function applyFilter(){
    const q = $("searchInput").value.trim().toLowerCase();
    if (!q){ renderTable(rawAll); return; }

    const out = rawAll.filter(r=>{
      return String(r.folio ?? "").toLowerCase().includes(q) ||
             String(r.telefono ?? "").toLowerCase().includes(q) ||
             String(r.nombre ?? "").toLowerCase().includes(q);
    });

    renderTable(out);
  }

  async function load(){
    try{
      // CONFIG
      const cfgRes = await fetch(CONFIG, {cache:"no-store"}).then(r=>r.json());
      const cfg = cfgRes.cfg || {};

      $("weekTxt").textContent = cfg.subtitulo || cfg.titulo || "‚Äî";

      partidos = (cfg.partidos || []).slice(0,9);
      resultados = (cfg.resultados || []).slice(0,9);
      marcadores = (cfg.marcadores || []).slice(0,9);

      renderMatches();

      // CLASIF
      const res = await fetch(ENDPOINT, {cache:"no-store"}).then(r=>r.json());
      const data = res.data || {headers:[], rows:[]};
      const headers = (data.headers || []).map(x => String(x).toLowerCase());

      const iF = headers.indexOf("folio");
      const iN = headers.indexOf("nombre");
      const iT = headers.indexOf("telefono_envio"); // solo para b√∫squeda
      const iA = headers.indexOf("aciertos");

      if (iF<0 || iN<0 || iA<0){
        console.warn("Headers inv√°lidos:", headers);
        return;
      }

      const startSel = iN + 1;
      const endSel   = iA;

      rawAll = (data.rows || []).map(r=>{
        const nombreShow = String(r[iN] ?? "").trim();
        return {
          folio: r[iF],
          telefono: (iT>=0 ? r[iT] : ""),
          nombre: nombreShow.toLowerCase(),
          nombre_show: nombreShow, // ‚úÖ como venga (si quieres min√∫sculas: nombreShow.toLowerCase())
          sels: r.slice(startSel, endSel).slice(0,9),
          aciertos: r[iA],
          _lugar: 0
        };
      });

      computePlaces(rawAll);
      applyFilter();

    }catch(err){
      console.error(err);
    }
  }

  $("searchInput").addEventListener("input", applyFilter);

  load();
  setInterval(load, REFRESH_MS);
</script>

</body>
</html>
